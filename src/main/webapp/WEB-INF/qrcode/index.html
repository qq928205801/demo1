<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>手机号码</title>
		
		<!-- Add to homescreen for Chrome on Android -->
		<meta name="mobile-web-app-capable" content="yes">
		<link rel="icon" sizes="192x192" href="img/app-icon72x72@2x.png">
		
		<!-- Add to homescreen for Safari on iOS -->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="apple-mobile-web-app-title" content="Amaze UI"/>
		<link rel="apple-touch-icon-precomposed" href="img/app-icon72x72@2x.png">
		
		<!-- Tile icon for Win8 (144x144 + tile color) -->
		<meta name="msapplication-TileImage" content="img/app-icon72x72@2x.png">
		<meta name="msapplication-TileColor" content="#0e90d2">
		
		<link rel="stylesheet" href="css/amazeui.css">
		<link rel="stylesheet" href="css/app.css">
		
		<link rel="stylesheet" href="css/mobiscroll.custom-2.6.2.min.css" />
		
		<script language="JavaScript" src="js/jquery-3.2.1.js"></script>
		<script language="JavaScript" src="js/amazeui.js"></script>
		<script language="JavaScript" src="js/date.js"></script>
		<script language="JavaScript" src="js/mobiscroll.custom-2.6.2.min.js"></script>
		
		<style type="text/css">
			img{
				width: 100px;
  				height: 100px;
			}
		</style>
	</head>
	<body>
		
		<!--手机绑定开始-->
		
		<form class="am-form am-form-horizontal telephonebind">
			<fieldset>
				<legend>手机号码绑定</legend>
				<div class="am-form-group">
					<label for="doc-ipt-3" class="am-u-sm-3 am-form-label">手机号码</label>
				    <div class="am-u-sm-9">
				      <input type="text" id="doc-ipt-3" placeholder="请您输入手机号码" class="telephone-value">
				    </div>
				</div>
				
				<div class="am-form-group">
					<label class="am-u-sm-3 am-form-label">验证码</label>
				    <div class="am-u-sm-5">
				      <input type="text" placeholder="请输入验证码" class="certifycode" >
				    </div>
				    <div class="am-u-sm-4"> 
				    	<input type="button" class="am-btn am-btn-success" onclick="clickButton(this)" value="获取验证码"/>
				    </div>
				</div>
				
				<p>
					<a class="am-btn am-btn-success telephone-ok am-btn-block"  
			  		data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0, width: 400, height: 225}">
			  			提交
		  			</a>
				</p>
			</fieldset>
		</form>
		
		<!--手机绑定结束-->
		
		<!--菜单列表开始-->
		
		<div class="menu">
			<legend>菜单列表</legend>
			
			<div class="am-g">
				<div class="am-u-sm-6">
					<button type="button" class="am-btn am-btn-primary park"  
				  		data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0, width: 400, height: 225}">停车</button>
				</div>
				<div class="am-u-sm-6">
					<button type="button" class="am-btn am-btn-primary violation">违规举报</button>
				</div>
			</div>
		
		</div>
		
		<input type="text" placeholder="请选择时长" class="minute-input am-btn-block"/>
		<div style="display: none;">
		    <select class="minute" placeholder="请您选择时长(分钟)">
	          <option value="5"><span>5</span></option>
			  <option value="10"><span>10</span></option>
			  <option value="15"><span>15</span></option>
			  <option value="20"><span>20</span></option>
			  <option value="25"><span>25</span></option>
			  <option value="30"><span>30</span></option>
	 		</select>
		</div>
	
		<div class="am-modal am-modal-confirm" tabindex="-1" id="my-confirm-minute">
		  <div class="am-modal-dialog">
		    <div class="am-modal-hd"></div>
		    <div class="am-modal-footer">
		      <span class="am-modal-btn" data-am-modal-confirm>确定</span>
		    </div>
		  </div>
		</div>
		
		<!--菜单列表结束-->
		
		
		<div class="am-modal am-modal-confirm" tabindex="-1" id="my-confirm">
		  <div class="am-modal-dialog">
		    <div class="am-modal-hd"></div>
		    <div class="am-modal-footer">
		      <span class="am-modal-btn" data-am-modal-confirm>确定</span>
		    </div>
		  </div>
		</div>
		
		
		
		
		<!--违规举报开始-->
		
		<div class="violationsection">
			<legend>违规举报</legend>
			<div class="am-form-group">
				<label for="doc-license-mobile">车牌号码</label>
				<input type="text" id="carNum" name="carNum" placeholder="请您输入车牌号码" required="required"/>
			</div>
				
			<div class="am-form-group am-form-file">
			  <label for="name">上传图片</label>
			  <div>
				  <span class="am-form-group am-form-file">
				  	<img id="image" src="img/uploadimag.jpg"/>
				  	<input id="image_upload" name="image_upload" type="file" accept="image/*"/>
				  	<small style="color: #dd4b39;display: none;">请上传照片</small>
				  </span>
				  <span class="am-form-group am-form-file">
				  	<img id="image_2" src="img/uploadimag.jpg"/>
				  	<input id="image_upload_2" name="image_upload_2" type="file" />
				  	<small style="color: #dd4b39;display: none;">请上传照片</small>
				  </span>
				  <span class="am-form-group am-form-file"> 
				  	<img id="image_3" src="img/uploadimag.jpg"/>
				  	<input id="image_upload_3" name="image_upload_3" type="file"/>
				  	<small style="color: #dd4b39;display: none;">请上传照片</small>
				  </span>
			  </div>
			</div>
			
			
			<div class="am-form-group">
				<label for="doc-ta-1">原因描述</label>
				<textarea rows="10" cols="35" id="description" name="description"></textarea>
			</div>
			
			<p>
				<div class="am-g">
					<div class="am-u-sm-6">
						<button class="am-btn am-btn-primary  violationback">返回</button>
					</div>
					<div class="am-u-sm-6">
						<button type="submit" class="am-btn am-btn-success violationsubmit">提交</button>
					</div>
				</div>
			</p>
		</div>
	
		<!--违规举报结束-->
		
		
	</body>
	
	<script language="JavaScript">
			
			function clickButton(obj){
			    var obj = $(obj);
			    obj.attr("disabled","disabled");/*按钮倒计时*/
			    var time = 60;
			    var set=setInterval(function(){
				    obj.val(--time+"(s)");
				    }, 1000);/*等待时间*/
			    setTimeout(function(){
				    obj.attr("disabled",false).val("重新获取验证码");/*倒计时*/
				    clearInterval(set);
				    }, 60000);
			}
		
			//获取url中参数
			function getUrlParam(name) {
		      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
		      var r = window.location.search.substr(1).match(reg); //匹配目标参数
		      if (r != null) return unescape(r[2]); return null; //返回参数值
		    }
			
			
			function upload(inputId, imageId){
				$("#" + inputId).on("change",function(){
			    	if(typeof(FileReader) != "undefined"){
			    		var regex = /(.jpg|.jpeg|.gif|.png|.bmp)$/;
			    		$($(this)[0].files).each(function(){
			    			var file = $(this);
			    			if(regex.test(file[0].name.toLowerCase())){
			    				var reader = new FileReader();
			    				reader.onload = function(e){
			    					$("#" + imageId).attr("src", e.target.result);
			    				}
			    				reader.readAsDataURL(file[0]);
			    			}else{
			    				$("#my-confirm .am-modal-hd").html(file[0].name + "is not a valid image file.");
			    				$("#my-confirm").modal({
			    					onConfirm:function(){
			    						
			    					}
			    				})
			    				return false;
			    			}
			    		})
			    	}
			    })
			}
		
			$(document).ready(function(){
				var url = "http://47.93.237.6:8080/wheelchair/getData.jsp";
				//这个参数应该从二维码中获取
//				var lotId = "d491ba20-2681-11e8-ae1d-00163e104758";
				var lotId = getUrlParam("lotId");
				var uid = "";
				if(getUrlParam("uid")){
					uid = getUrlParam("uid");
				}
				
				//手机绑定开始
				
				//如果参数是含有其他参数
				if(uid){
					$(".telephonebind").hide();
					$(".menu").show();
					$(".violationsection").hide();
				}else{
					//隐藏菜单列表
					$(".menu").hide();
					//隐藏违规举报
					$(".violationsection").hide();
				}
				
				
				//验证电话号码是否有效
				$(".telephone-value").on("blur", function(){
					var telephoneValue = $(".telephone-value").val();
					var regex = /^(((13[0-9]{1})|(14[0-9]{1})|(17[0]{1})|(15[0-3]{1})|(15[5-9]{1})|(18[0-9]{1}))+\d{8})$/;
					if(telephoneValue){
						if(!regex.test(telephoneValue)){
							$("#my-confirm .am-modal-hd").html("请输入有效的电话号码");
							$("#my-confirm").modal({
								onConfirm:function(){
									$(location).attr("href", "index.html");
								}
							});
						}
					}
				})
				
				
				$(".telephone-ok").on("click", function(){
					var telephone = $(".telephone-value").val();
					if(telephone == "" || telephone == undefined){
						$("#my-confirm .am-modal-hd").html("电话号码为空，请您输入电话号码");
						$("#my-confirm").modal({
							onConfirm:function(){
								$(location).attr("href", "index.html");
							}
						});
					}else{
						var fparam = '{"usr_id":"'+ telephone+'"}'
						$.ajax({
							url:url,
							type:"POST",
							async:false,
							data:{
								fname:"registerUser",
								fparam:fparam
							},
							success:function(data){
								var jsondata = JSON.parse(data);
								if(jsondata.success == 1){
									uid = jsondata.result.usr_id;
								}
							}
							
						})
					}
					
					//跳转到menu页面中
//					$(location).attr("href","menu.html?uid=" + uid + "&lotId=" + lotId);
					//隐藏手机绑定
					$(".telephonebind").hide();
					//显示菜单列表
					$(".menu").show();
					
				})
				
				
				//手机绑定结束---------------------------------------------
				
				//菜单列表开始----------------------------------------------
				
				$(".minute-input").hide();
		
				//违规举报
				$(".violation").on("click", function(){
//					$(location).attr("href", "violation.html?uid=" + uid + "&lotId=" + lotId);
					//隐藏菜单列表
					$(".menu").hide();
					//显示违规举报
					$(".violationsection").show();
				})
				
				
				var fname = "parkingData";
				
			
				//开始停车
				$(".park").on("click", function(){
					var fparam = '{"uid": "' + uid+'","lotId": "' + lotId+ '"}';
					//向后台请求parkingData
					$.ajax({
						type:"post",
						url:url,
						async:false,
						data:{
							fname:fname,
							fparam:fparam
						},
						success:function(data){
							var json = JSON.parse(data);
							//成功的返回
							if(json.success == 1){
								$("#my-confirm .am-modal-hd").html(json.result.msg);
								//当前车位未被预约，是否预约并直接停车?(社会车辆)
								if(json.result.msg == "当前车位未被预约，是否预约并直接停车?(社会车辆)"){
									//是否预约
									$("#my-confirm").modal({
										onConfirm:function(){
											$(".park").hide();
											$(".violation").hide();
											$(".minute-input").show();
										},
										onCancel:function(){
//											$(location).attr("href", "index.html?lotId=" + lotId);
											//显示菜单列表
											$(".menu").show();
										}
									});
									
									//请您选择时长
									$(".minute-input").on("click", function(){
										$(".minute").mobiscroll("show");
										return false;
									})
									
									var today = new Date();
									$(".minute").mobiscroll().select({
										theme:"android-ics light",
										mode:"scroller",
										display:"bottom",
										lang:"zh",
										headerText: today.Format("yyyy-MM-dd hh:mm:ss") + "-请选择时长(分钟)",
										onSet:function(obj, inst){
											$(".minute-input").val(obj.valueText);
										},
										onSelect:function(value){
											
											var t_s = today.getTime();
											if(value != "" || value != undefined){
												today.setTime(t_s+ value * 1000 * 60);
											}
											console.log(today.Format("yyyy-MM-dd hh:mm:ss"));
											
											fname = "reserveLotAndParkingByParams";
											fparam ='{"uid":"'+ uid +'","lotId":"'+ lotId + '","endTime":"'+ today.Format("yyyy-MM-dd hh:mm:ss")+'"}'; 
											
											//向后台请求reserveLotAndParkingByParams
											$.ajax({
												type:"post",
												url:url,
												async:false,
												data:{
													fname:fname,
													fparam:fparam
												},
												success:function(data){
													var json = JSON.parse(data);
													if(json.success == 1){
														$("#my-confirm-minute .am-modal-hd").html(json.result.msg);
													}
												}
											});
											
											//预约成功并停车						
											$("#my-confirm-minute").modal({
												onConfirm:function(){
													$(".park").show();
													$(".violation").show();
													$(".minute-input").hide();
													$(location).attr("href","index.html?lotId=" + lotId + "&uid=" + uid);
													
												}
											});
											
										}
									})
								}else if(json.result.msg == "本人扫码，是否现在结束使用？"){
									fname = json.result.function;
									$("#my-confirm .am-modal-hd").html(json.result.msg);
								
									$("#my-confirm").modal({
										onConfirm:function(){
											console.log(json.result.msg);
											$.ajax({
												url:url,
												type:"post",
												async:false,
												data:{
													fname:fname,
													fparam:fparam
												},
												success:function(dataStr){
													var jsonData = JSON.parse(dataStr);
													if(jsonData.success == 1){
														$("#my-confirm-minute .am-modal-hd").html(jsonData.result.msg);
			//													$(location).attr("href","menu.html?uid=" + uid + "&lotId=" + lotId);
													}
												}
											})
											
											//成功的结束
											$("#my-confirm-minute").modal({
												onConfirm:function(){
													$(location).attr("href","index.html?lotId=" + lotId + "&uid=" + uid);
												
													//显示菜单列表
//													$(".menu").show();
													//显示手机绑定
//													$(".telephonebind").show();
//													$(".menu").hide();
												}
											});
									
										}
									});
									
//									fname = "updateAppStatus";
									
									
								}else if(json.result.msg == "非预约者本人，当前车位被预约，用户已超时（超过起始预约时间20分钟），是否举报？"){
//									$(location).attr("href", "violation.html?uid=" + uid + "&lotId=" + lotId);
									//隐藏菜单列表
									$(".menu").hide();
									//显示违规举报
									$(".violationsection").show();
								}else if(json.result.msg == "非预约者本人，当前车位被预约或使用中（注：当前预约开始前15分钟内不再接受新的预约）"){
									$("#my-confirm-minute .am-modal-hd").html(json.result.msg);
									$("#my-confirm-minute").modal({
										onConfirm:function(){
											$(".menu").show();
											$(".violationsection").hide();	
										}
									});
								}
							}
						}
					});
					
				})
				
				//菜单列表结束--------------------------------
				
				
				//违规举报开始----------------------------------
				
				upload("image_upload", "image");
			    upload("image_upload_2", "image_2");
			    upload("image_upload_3", "image_3");
			    
			    
			    //提交
			    $(".violationsubmit").on("click", function(){
			    	var carNum = $("#carNum").val();
				    var description = $("#description").val();
				    var image_upload = $("#image_upload")[0].files[0];
				   	var image_upload_2 = $("#image_upload_2")[0].files[0];
				   	var image_upload_3 = $("#image_upload_3")[0].files[0];
				    
				    
			    	var fname = "reportViolation";
				    var fparam = '{"description":"'+description +'","carNum":"'+carNum+'","lotId":"'+lotId+'","uid":"'+uid+'"}';
				    
				    var formData = new FormData();
				    formData.append("file1", image_upload);
				    formData.append("file2", image_upload_2);
				    formData.append("file3", image_upload_3);
				    formData.append("fname", fname);
				    formData.append("fparam", fparam);
				    
			    	$.ajax({
			    		url:url,
			    		type:"post",
						async:false,
						cache:false,
						contentType:false,
						processData:false,
						data:formData,
						success:function(data){
							var jsonData = JSON.parse(data);
							if(jsonData.success == 1 && jsonData.result.reportId != ""){
//								$(location).attr("href","menu.html?uid=" + uid + "&lotId=" + lotId);
								//隐藏违规举报
								$(".violationsection").hide();
								//显示菜单列表
								$(".menu").show();
							}
						}
			    	})
			   
			    })
			    
			    //返回菜单列表
			    $(".violationback").on("click", function(){
			    	//隐藏违规举报
					$(".violationsection").hide();
					//显示菜单列表
					$(".menu").show();
			    })
				
				//违规举报结束---------------------------------
			})
		</script>
</html>
